import requests
from datetime import datetime, timedelta
import pytz

SEASON = 2026
URL = f"https://ergast.com/api/f1/{SEASON}.json"

response = requests.get(URL, timeout=10)

if response.status_code != 200:
    print("Erro ao acessar API")
    exit(0)

data = response.json()

races = (
    data.get("MRData", {})
        .get("RaceTable", {})
        .get("Races", [])
)

brt = pytz.timezone("America/Sao_Paulo")

ics = [
    "BEGIN:VCALENDAR",
    "VERSION:2.0",
    "PRODID:-//F1 Calendar//EN",
    "CALSCALE:GREGORIAN"
]

if not races:
    print("Nenhuma corrida encontrada para a temporada.")
else:
    for race in races:
        date_str = race.get("date")
        time_str = race.get("time", "00:00:00Z")

        try:
            utc_dt = datetime.fromisoformat(
                f"{date_str}T{time_str.replace('Z','')}"
            )
            utc_dt = pytz.utc.localize(utc_dt)
        except Exception:
            continue

        start = utc_dt.astimezone(brt)
        end = start + timedelta(hours=2)

        ics.extend([
            "BEGIN:VEVENT",
            f"UID:{race['round']}@f1-calendar",
            f"DTSTAMP:{datetime.utcnow().strftime('%Y%m%dT%H%M%SZ')}",
            f"DTSTART:{start.strftime('%Y%m%dT%H%M%S')}",
            f"DTEND:{end.strftime('%Y%m%dT%H%M%S')}",
            f"SUMMARY:{race['raceName']}",
            f"DESCRIPTION:{race['Circuit']['circuitName']}",
            "BEGIN:VALARM",
            "TRIGGER:-P1D",
            "ACTION:DISPLAY",
            "DESCRIPTION:Corrida amanhã",
            "END:VALARM",
            "BEGIN:VALARM",
            "TRIGGER:-PT30M",
            "ACTION:DISPLAY",
            "DESCRIPTION:Corrida em 30 minutos",
            "END:VALARM",
            "END:VEVENT"
        ])

ics.append("END:VCALENDAR")

with open("f1_2026_brt.ics", "w", encoding="utf-8") as f:
    f.write("\n".join(ics))

print("Calendário gerado com sucesso.")
